# .github/workflows/sync-page-to-cnb.yml
name: Sync Page Branch to CNB (Auto Deploy)

on:
  push:
    branches:
      - page   # å½“ page åˆ†æ”¯æœ‰æ–°æäº¤æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆç”±æ¯æ—¥å£çº¸ç”Ÿæˆè„šæœ¬æ¨é€ï¼‰
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› ï¼ˆå¦‚ï¼šæµ‹è¯•éƒ¨ç½²æˆ–ç´§æ€¥æ›´æ–°ï¼‰'
        required: false
        default: 'Manual run'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ğŸ” 1. æ£€å‡º page åˆ†æ”¯å†…å®¹
      - name: ğŸ“¥ Checkout page branch
        uses: actions/checkout@v5
        with:
          ref: page
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç¡®ä¿ git diff èƒ½æ­£å¸¸å·¥ä½œ

      # ğŸ” 2. æ£€æµ‹æ˜¯å¦æœ‰å®é™…å˜æ›´ï¼ˆå…¼å®¹é¦–æ¬¡æäº¤ï¼‰
      - name: ğŸ” Check for file changes
        id: check
        run: |
          # åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºé¦–æ¬¡æäº¤ï¼ˆæ— çˆ¶æäº¤ï¼‰
          if [ -z "$(git rev-parse --verify HEAD^ 2>/dev/null)" ]; then
            echo "ğŸ†• First commit detected â€” assuming changes exist and proceeding."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            # è·å–ä¸Šä¸€æ¬¡æäº¤ä¸å½“å‰æäº¤ä¹‹é—´çš„æ–‡ä»¶å·®å¼‚
            CHANGES=$(git diff --name-only HEAD^ HEAD)
            if [ -z "$CHANGES" ]; then
              echo "âœ… No changes detected since last commit. Skipping sync."
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "âœ¨ Changes detected:"
              echo "$CHANGES"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          fi

      # ğŸš€ 3. æ¨é€åˆ° CNBï¼ˆä»…å½“æœ‰å˜æ›´æ—¶æ‰§è¡Œï¼‰
      - name: ğŸš€ Push to CNB & Trigger Deployment
        if: steps.check.outputs.skip == 'false'
        env:
          CNB_USERNAME: ${{ secrets.CNB_USERNAME }}
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
        run: |
          echo "ğŸ§¹ Cleaning old Git metadata..."
          rm -rf .git

          echo "ğŸŒ± Initializing new Git repository..."
          git init
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          echo "ğŸ’¾ Adding all static files to staging area..."
          git add .

          echo "ğŸ“ Committing with timestamp..."
          # ä½¿ç”¨ %% è½¬ä¹‰ %ï¼Œå› ä¸º YAML ä¸­ % æ˜¯ç‰¹æ®Šå­—ç¬¦
          git commit -m "âš¡ Sync from GitHub page branch: $(date +'%%Y-%%m-%%d %%H:%%M:%%S')"

          echo "ğŸ”— Setting remote to CNB repository..."
          git remote add origin "https://${{ secrets.CNB_USERNAME }}:${{ secrets.CNB_TOKEN }}@cnb.cool/gyhwd.top/AhHui-Homepage.git"

          echo "ğŸš€ Forcing push to main branch on CNB (default deployment branch)..."
          git branch -M main
          git push --force --quiet origin main

          echo "ğŸ‰ Successfully pushed to CNB: wojack/AhHui-Homepage"
          echo "ğŸŒ Website will auto-deploy at: https://home.gyhwd.top"