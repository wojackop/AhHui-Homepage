# .github/workflows/sync-page-to-cnb.yml
name: Sync Page Branch to CNB (Auto Deploy)

# é¿å…å¹¶å‘å †ç§¯
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true
  
on:
  repository_dispatch:
    types: [sync-to-cnb]  # ğŸ‘ˆ ç›‘å¬æ¥è‡ª generate-static-site.yml çš„äº‹ä»¶
  workflow_dispatch:
    inputs:
      reason:
        description: 'æµ‹è¯•éƒ¨ç½²'
        required: false
        default: 'Manual run'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ğŸ” 1. æ£€å‡º page åˆ†æ”¯å†…å®¹
      - name: ğŸ“¥ Checkout page branch
        uses: actions/checkout@v5
        with:
          ref: page
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç¡®ä¿ git diff èƒ½æ­£å¸¸å·¥ä½œ

      # ğŸ” 2. å¼ºåˆ¶éƒ¨ç½²ï¼ˆä¸å†æ£€æŸ¥å˜æ›´ï¼‰
      - name: ğŸ” Always deploy
        id: check
        run: |
          echo "âœ… Page branch updated with new commit. Forcing deployment to CNB."
          echo "skip=false" >> $GITHUB_OUTPUT
      
      # ğŸš€ 3. æ¨é€åˆ° CNB
      - name: ğŸš€ Push to CNB & Trigger Deployment
        if: steps.check.outputs.skip == 'false'
        env:
          CNB_USERNAME: ${{ secrets.CNB_USERNAME }}
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
        run: |
          echo "ğŸ§¹ Cleaning old Git metadata..."
          rm -rf .git

          echo "ğŸŒ± Initializing new Git repository..."
          git init
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          echo "ğŸ’¾ Adding all static files to staging area..."
          git add .

          echo "ğŸ“ Committing with timestamp..."
          git commit -m "[skip ci] ğŸ–¼ï¸ Auto-update Bing images and deploy $(date +'%%Y-%%m-%%d %%H:%%M:%%S')"

          echo "ğŸ”— Setting remote to CNB repository..."
          git remote add origin "https://${{ secrets.CNB_USERNAME }}:${{ secrets.CNB_TOKEN }}@cnb.cool/gyhwd.top/AhHui-Homepage.git"

          echo "ğŸš€ Forcing push to main branch on CNB..."
          git branch -M main
          git push --force --quiet origin main

          echo "ğŸ‰ Successfully pushed to CNB: wojack/AhHui-Homepage"

      # 4.ğŸ‘‡ è§¦å‘æœåŠ¡å™¨éƒ¨ç½²
      - name: ğŸ”” Trigger server deployment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'deploy-to-server',
              client_payload: {
                message: 'CNB updated, triggering server sync',
                commit: context.sha
              }
            }) 