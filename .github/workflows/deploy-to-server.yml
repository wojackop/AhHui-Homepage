# .github/workflows/deploy-to-server.yml
name: Deploy CNB Content to Server (Auto via Event)

on:
  repository_dispatch:
    types: [deploy-to-server]  # ç›‘å¬æ¥è‡ªå…¶ä»–å·¥ä½œæµçš„è‡ªå®šä¹‰äº‹ä»¶
  workflow_dispatch:           # ä¿ç•™æ‰‹åŠ¨è§¦å‘èƒ½åŠ›ï¼ˆè°ƒè¯•ç”¨ï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ” 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆç”¨äºè·å– secretsï¼‰
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5

      # ğŸš€ 2. ä½¿ç”¨ SSH è¿æ¥æœåŠ¡å™¨å¹¶éƒ¨ç½²
      - name: ğŸ–¥ï¸ Deploy to server via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}       # ç§é’¥å†…å®¹ï¼ˆå®Œæ•´ PEM æ ¼å¼ï¼‰
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || 22 }}   # é»˜è®¤ 22ï¼Œå¯ä¸å¡«
          script: |
            # è®¾ç½®å˜é‡
            TARGET_DIR="/opt/1panel/www/sites/home.gyhwd.top/index"
            TEMP_DIR="/tmp/cnb-deploy"

            echo "ğŸ§¹ Cleaning old temporary directory..."
            rm -rf "$TEMP_DIR"
            mkdir -p "$TEMP_DIR"

            echo "ğŸ”— Cloning CNB repository into temporary directory..."
            git clone --depth 1 \
              "https://${{ secrets.CNB_USERNAME }}:${{ secrets.CNB_TOKEN }}@cnb.cool/gyhwd.top/1panel-appstore.git" \
              "$TEMP_DIR"

            echo "ğŸ“‚ Clearing target directory..."
            rm -rf "$TARGET_DIR"/*
            mkdir -p "$TARGET_DIR"

            echo "ğŸ”„ Copying CNB content to server site directory (flattened)..."
            cp -r "$TEMP_DIR"/* "$TARGET_DIR/"

            echo "ğŸ—‘ï¸ Cleaning up temporary directory..."
            rm -rf "$TEMP_DIR"

            echo "âœ… Successfully deployed! Files synced to: $TARGET_DIR"
            ls -la "$TARGET_DIR"  # Output final structure for debugging

            # ï¼ˆå¯é€‰ï¼‰é‡å¯ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
            # systemctl reload nginx

            echo "ğŸŒ Website will auto-deploy at: https://home.gyhwd.top"